name: Project Automation

on:
  create:

jobs:
  move-to-in-progress:
    if: github.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - name: Move issue to In Progress
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const match = branch.match(/(\d+)/);
            if (!match) {
              console.log('No issue number found in branch name');
              return;
            }
            
            const issueNumber = parseInt(match[1]);
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            try {
              await github.rest.issues.get({
                owner,
                repo,
                issue_number: issueNumber
              });
            } catch (e) {
              console.log(`Issue #${issueNumber} not found`);
              return;
            }
            
            console.log(`Found issue #${issueNumber}, moving to In Progress`);
            
            const projectNumber = 3;
            const username = owner;
            
            const query = `
              query($username: String!, $projectNumber: Int!) {
                user(login: $username) {
                  projectV2(number: $projectNumber) {
                    id
                    field(name: "Status") {
                      ... on ProjectV2SingleSelectField {
                        id
                        options {
                          id
                          name
                        }
                      }
                    }
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                            repository {
                              name
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;
            
            const result = await github.graphql(query, {
              username,
              projectNumber
            });
            
            const project = result.user.projectV2;
            if (!project) {
              console.log('Project not found');
              return;
            }
            
            const projectItem = project.items.nodes.find(item => 
              item.content?.number === issueNumber && 
              item.content?.repository?.name === repo
            );
            
            if (!projectItem) {
              console.log('Issue not in target project');
              return;
            }
            
            const statusField = project.field;
            const inProgressOption = statusField.options.find(
              opt => opt.name.toLowerCase().replace(/\s/g, '') === 'inprogress'
            );
            
            if (!inProgressOption) {
              console.log('In Progress status not found');
              return;
            }
            
            const mutation = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId
                  itemId: $itemId
                  fieldId: $fieldId
                  value: { singleSelectOptionId: $optionId }
                }) {
                  projectV2Item {
                    id
                  }
                }
              }
            `;
            
            await github.graphql(mutation, {
              projectId: project.id,
              itemId: projectItem.id,
              fieldId: statusField.id,
              optionId: inProgressOption.id
            });
            
            console.log(`Moved issue #${issueNumber} to In Progress`);
